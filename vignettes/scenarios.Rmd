---
title: "Scenarios"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Scenarios}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(billionaiRe)

df <- tibble::tibble(
    value = 60:80,
    year = 2010:2030,
    ind = "adult_obese",
    type = "reported",
    iso3 = "AFG",
    scenario = "default",
    source = NA_character_
  ) %>%
    dplyr::mutate(scenario = dplyr::case_when(
      year > 2021 ~ "historical",
      TRUE ~ scenario
    ),
    type = dplyr::case_when(
      year > 2021 ~ "projected",
      TRUE ~ type
    ))
```

## Definition

In the Triple Billions and the billionaiRe package context, scenarios are understood as alternative, plausible, description of how the future may develop based on a set of defined assumptions.

Scenarios must:

1.  Be [tidy](https://r4ds.had.co.nz/tidy-data.html): each row is a unique combination of iso3 country-code, year, indicator, and scenario (if relevant).
2.  Contain **all** and **only** the data that is strictly needed for calculations with billionaiRe

Four main sets of scenarios can be identified, from the most basic to the more complex:

1. **Basic scenario**: Those scenarios are the building blocks of the other scenarios, but they can also be called on their own. They can reach a fixed target at a specified year (`scenario_fixed_target()`), follow a specific rate of change (`scenario_aroc()`), etc. See [Basic scenario] for more details.
2. **Target scenarios**: Target-based scenarios apply indicator-specific targets or trajectories to be reached by a specific date (e.g. Sustainable Development Goal targets (called `sdg` scenarios)).
3. **Benchmarking scenarios**: Benchmarking scenarios compare performance of countries given various grouping and aim at a specified sub-set of best performing countries.
4. **Mixed scenarios**: Developped with indicator-level subject matter knowledge to pick realistic improvement scenarios (e.g. `acceleration` scenarios)

If billionaiRe require data that is missing in the scenario, they will be recycled from other scenarios (see [Data recycling](data-recycling.html)).

## How to use billionaiRe scenarios

Presentation of `add_scenario()`

```{r scenario-example, include = TRUE, eval = FALSE}
library(billionaiRe)

df <- tibble::tibble(
    value = 60:80,
    year = 2010:2030,
    ind = "adult_obese",
    type = "reported",
    iso3 = "AFG",
    scenario = "default",
    source = NA_character_
  ) %>%
    dplyr::mutate(scenario = dplyr::case_when(
      year > 2021 ~ "historical",
      TRUE ~ scenario
    ),
    type = dplyr::case_when(
      year > 2021 ~ "projected",
      TRUE ~ type
    ))

test_hep <- df %>%
  add_scenario(
    scenario_function = "halt_rise", # select from a pre-determined list of scenarios
    scenario_col = "scenario",
    default_scenario = "covid_dip_lag" # indicates the scenario used as the default (in addition to `routine` and `reference_infilling`, where relevant)
  ) %>%
  add_scenario(
    scenario_function = "percent_baseline", # picks from a pre-determined list of scenarios
    percent_change = 10,
    scenario_col = "scenario",
    default_scenario = "covid_dip_lag"
  ) %>%
  recycle_data(
    billion = "hep", # One function for each billions, so need to specify which one this is applied to.
    scenario_col = "scenario",
    default_scenario = "covid_dip_lag",
    scenario_reported_estimated = "routine",
    scenario_reference_infilling = "reference_infilling",
    include_projection = TRUE,
    recycle_campaigns = TRUE
  ) %>% # Warnings come from the call to recycle as Afghanistan as in 2018 values for detect_respond. Thus, all scenarios return NAs for Afghanistan for that year as they all require a 2018 value.
  transform_hep_data(
    scenario_col = "scenario",
    recycle = FALSE
  ) %>% # adds a parameter to `transform_` functions to recycle. In this pipeline it is redundant as data was already recycled.
  calculate_hep_components(scenario_col = "scenario") %>%
  calculate_hep_billion(scenario_col = "scenario", end_year = 2025) %>%
  dplyr::filter(
    ind %in% c(
      "prevent",
      "espar",
      "detect_respond",
      "hep_idx"
    ),
    year == 2025
  )
```

## Basic scenarios

```{r child = "basic-scenarios.Rmd"}
```

## Target scenarios

## Benchmarking scenario

## Mixed scenarios
Currently there are three wrapper functions implemented:

* `add_scenario` that wraps around any of the scenarios in its `scenario_function` parameter
* `acceleration` that implements the acceleration scenarios defined in coordination with WHO technical programs.
* `sdg` that implements acceleration scenarios to reach sustainable development goals.

Each of the base scenario is wrapped in `add_scenario`. This function calls a `add_` function for each indicator in the data frame. This allows to apply the same base scenario to all indicators in the data frame, while passing indicator specific defaults:

```{r scenario-wrapper-example, include = TRUE, eval = FALSE}
library(billionaiRe)

df <- tibble::tibble(
  value = 80:100,
  year = 2010:2030,
  ind = "adult_obese",
  iso3 = "testalia",
  scenario = "default"
)

add_scenario(df, scenario_function = "halt_rise") %>%
  dplyr::filter(scenario == "halt_rise")

```

Behind the scenes, `add_scenario` first get all unique indicators present in `df`, then passed each of them to `add_scenario_indicator()`. `add_scenario_indicator()` then find the `add_scenario_adult_obese` function and runs it with `df` and `halt_rise`. `add_scenario_adult_obese` then passes appropriate parameters to `scenario_halt_rise`. In this case, this is mostly to pass `small_is_best` to the scenario function.

The `...` ellipsis is used to pass parameters down the functions.

## Internal use scenarios

There are three *internal use* special case scenario:

* `routine`: stores the `reported` and `estimated` data
* `reference_infilling`: stores WHO technical programs projected data (either `projected` or `imputed`).
* `covid_shock`: stores the data that correspond to the COVID-19 shock.

All together those three scenarios are the *base scenarios*. They are the spine of other scenarios and act then as a filling when scenarios do not contain the required data to build a full time series.

## Scenarios integration into data pipeline

The current Triple Billion data pipeline is composed of four main steps. billionaiRe is dealing only with the calculation step:

1.  Ingestion: Azure DevOps repo
2.  Projection: Azure DevOps repo
3.  Calculation: **billionaiRe**
4.  Export: *rapporteur*

The definition of the [Internal use scenarios] scenarios happen in the `ingestion` and `projection` steps, which are outside of the scope of the billionaiRe package.

Other scenarios are calculated at stage 3 (Calculation), as does the rest of the billionaiRe calculations. Those scenarios can be calculated with the `add_scenario()` function.

Within the Triple Billion calculations pipeline, adding the scenarios values should ideally be the first steps (i.e. before transforming the data). However, some event-based and trajectory-based scenarios, might require some level of data recycling before they run. If this is the case, errors should be produced.

The `add_scenario` functions is built on a range of pre-defined set of scenarios calculation functions that are called within the add_scenario function. There is then two layers of scenario functions that can be called :

1.  **wrappers functions** combine *basic scenario* to generate more complex scenarios like `acceleration`, `sdg`, etc. See [Wrappers functions for more details]
2.  **Basic scenario**: they are the building blocs of the wrapper functions. For instance, `scenario_fixed_target` sets the values on a linear trajectory towards a target by a certain year, `scenario_percent_baseline` sets a progression from the baseline with a fix percentage increase. See [Basic scenario] for more details.

#### Acceleration scenarios

Acceleration scenarios are a special case scenario that wraps different base scenario for each indicator. This is to take into consideration the specific cases of each indicator and what accelerating means for each of each individually. They can then be called directly from `add_scenario` or through indicator level function following the `accelerate_{indicator}` naming convention.

## Scenarios naming convention

* [Lower Snake case](https://en.wikipedia.org/wiki/Snake_case) is used

* Short and very descriptive names: use verbs as much as possible

* Use only commonly understood acronyms and abbreviations

* `event` scenarios start with them. E.g. covid, pre_covid_bau

    -   Sub-event scenarios should have a descriptive word rather than numbering or other undefined markers. **DO**: covid_never_return. **DON'T**: COVID_1

* `routine` is reserved for reported/estimated data

* `reference_infilling` is reserved for imputed/projected data

* `default` is reserved for the main data present on the dashboard

* `acceleration` is reserved for acceleration scenarios / trajectories

* `sdg` is reserved for sustainable development goals
